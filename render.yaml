# infra/render.yaml
services:
  # --- FastAPI backend -------------------------------------------------------
  - type: web
    name: agentive-api
    runtime: python
    rootDir: backend
    buildCommand: pip install --no-cache-dir -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/v1/health
    envVars:
      - key: LOG_LEVEL
        value: info
      - key: DATA_DIR
        value: /data
      - key: CONFIG_DIR
        value: /app/configs
      # lock CORS to your UI origin once UI is up
      - key: CORS_ORIGINS
        value: https://agentive-ui.onrender.com
      # optional features
      - key: GEMINI_API_KEY
        sync: false
      - key: GEMINI_MODEL
        value: gemini-2.5-flash
      - key: API_TOKEN                   
        sync: false
      - key: RATE_LIMIT_PER_MIN
        value: "60"
    disk:
      name: agentive-data
      mountPath: /data
      sizeGB: 2

  # --- Streamlit UI ----------------------------------------------------------
  - type: web
    name: agentive-ui
    runtime: python
    rootDir: frontend
    buildCommand: pip install --no-cache-dir -r requirements.txt
    startCommand: streamlit run app.py --server.port $PORT --server.address 0.0.0.0
    healthCheckPath: /
    envVars:
      # set after first deploy if you prefer the final URL
      - key: API_URL
        value: https://agentive-api.onrender.com/api/v1
      - key: API_TOKEN                   
        sync: false

  # --- (Optional) n8n orchestration -----------------------------------------
  - type: web
    name: agentive-n8n
    runtime: docker
    image:
      url: n8nio/n8n:latest
    plan: free
    healthCheckPath: /
    dockerCommand: sh -lc 'export N8N_PORT=$PORT; n8n start'
    envVars:
      - key: N8N_HOST
        value: agentive-n8n.onrender.com
      - key: N8N_PORT
        value: "10000"
      - key: N8N_ENCRYPTION_KEY          # set a random 32+ char string in dashboard
        sync: false
      - key: WEBHOOK_URL                 # helps external webhooks work
        value: https://agentive-n8n.onrender.com/
      - key: API_URL                     # so n8n can call the API
        value: https://agentive-api.onrender.com/api/v1
    disk:
      name: n8n-data
      mountPath: /home/node/.n8n
      sizeGB: 1
